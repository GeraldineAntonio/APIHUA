name: Scrape CapÃ­tulos AutomÃ¡tico

on:
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: scrape-workflow
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Instalar dependencias
        run: npm install
      
      - name: Crear directorio data
        run: mkdir -p data
      
      - name: Iniciar FlareSolverr
        run: |
          docker run -d \
            --name flaresolverr \
            -p 8191:8191 \
            -e LOG_LEVEL=info \
            ghcr.io/flaresolverr/flaresolverr:latest
          
          echo "â³ Esperando a FlareSolverr..."
          sleep 20
          
          for i in {1..10}; do
            if curl -f http://localhost:8191/health 2>/dev/null; then
              echo "âœ… FlareSolverr listo"
              exit 0
            fi
            echo "â³ Intento $i/10..."
            sleep 3
          done
          
          echo "âŒ FlareSolverr no respondiÃ³"
          exit 1
      
      - name: Ejecutar scraping
        run: npm run scrape
        env:
          FLARESOLVERR_URL: http://localhost:8191/v1
        timeout-minutes: 15
      
      - name: Verificar archivo generado
        run: |
          if [ ! -f data/capitulos.json ]; then
            echo "âŒ No se generÃ³ capitulos.json"
            exit 1
          fi
          
          TOTAL_ES=$(jq -r '.stats.totalEspanol // 0' data/capitulos.json)
          TOTAL_EN=$(jq -r '.stats.totalIngles // 0' data/capitulos.json)
          
          echo "ðŸ“Š EspaÃ±ol: $TOTAL_ES | InglÃ©s: $TOTAL_EN"
      
      - name: Verificar cambios
        id: check_changes
        run: |
          if git diff --quiet data/capitulos.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit y push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          
          TOTAL_ES=$(jq -r '.stats.totalEspanol' data/capitulos.json)
          TOTAL_EN=$(jq -r '.stats.totalIngles' data/capitulos.json)
          
          MAX_ATTEMPTS=5
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "ðŸ“¤ Intento $ATTEMPT/$MAX_ATTEMPTS"
            
            # Sincronizar con remote
            git fetch origin main
            
            # Guardar cambios locales
            git add data/capitulos.json
            git stash
            
            # Pull con rebase
            if git pull --rebase origin main; then
              echo "âœ… Rebase exitoso"
            else
              echo "âš ï¸ Rebase fallÃ³, abortando..."
              git rebase --abort
              git pull origin main
            fi
            
            # Restaurar cambios
            if git stash pop; then
              echo "âœ… Cambios restaurados"
            else
              echo "âš ï¸ Conflicto, usando nuestra versiÃ³n"
              git checkout --ours data/capitulos.json
            fi
            
            git add data/capitulos.json
            
            # Hacer commit
            git commit -m "ðŸ¤– Auto-update: ${TOTAL_ES} caps ES, ${TOTAL_EN} caps EN - $(date +%Y-%m-%d)" || true
            
            # Intentar push
            if git push origin main; then
              echo "âœ… Push exitoso"
              exit 0
            fi
            
            echo "âš ï¸ Push fallÃ³, reintentando..."
            ATTEMPT=$((ATTEMPT + 1))
            sleep 10
          done
          
          echo "âŒ FallÃ³ despuÃ©s de $MAX_ATTEMPTS intentos"
          exit 1
      
      - name: Limpiar
        if: always()
        run: |
          docker stop flaresolverr 2>/dev/null || true
          docker rm flaresolverr 2>/dev/null || true